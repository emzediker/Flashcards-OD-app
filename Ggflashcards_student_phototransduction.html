<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phototransduction Flashcards</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;padding:20px;background:#fff;color:#111;}
  .wrap{max-width:980px;margin:auto;}
  h1{font-size:22px;margin:0 0 12px;}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  select,input[type=search],button{padding:9px 10px;border:1px solid #ddd;border-radius:8px;background:#fff}
  .card{border:1px solid #ddd;border-radius:12px;padding:20px;min-height:180px;background:#fff;position:relative}
  .front{font-weight:600}
  .back{display:none;margin-top:12px}
  .ans{font-weight:700;font-size:1.06rem;margin:2px 0 6px}
  .exp{color:#555;font-size:0.96rem;line-height:1.35}
  .card img{max-width:100%;height:auto;border-radius:8px;margin-top:10px}
  .fav{position:absolute;top:10px;right:10px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .fav[aria-pressed="true"]{color:#e09b00;border-color:#caa14a}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#555}
  .nav{display:flex;gap:8px;margin-top:10px}
  .nav button{flex:1;font-weight:600}
  .note{margin-top:8px;font-size:13px;color:#666}
</style>

<!-- Supabase JS client (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h1>Phototransduction Flashcards</h1>

  <div class="bar">
    <label>Show:
      <select id="show">
        <option value="all">All</option>
        <option value="fav">Favorites</option>
      </select>
    </label>
    <label>Search:
      <input id="q" type="search" placeholder="Find text...">
    </label>
  </div>

  <div class="card" id="card">
    <div class="front" id="front"></div>
    <div class="back" id="back"></div>
    <button id="fav" class="fav" aria-pressed="false" title="Favorite">★</button>
  </div>

  <div class="meta">
    <div id="counter">0 / 0</div>
    <div id="status"></div>
  </div>

  <div class="nav">
    <button id="prev">◀ Prev</button>
    <button id="reveal">Reveal Answer</button>
    <button id="next">Next ▶</button>
  </div>

  <div class="note">
    Tip: ←/→ to move, R to reveal/hide, S to star.
    Favorites save per device and in the cloud when an email is set.
  </div>
</div>

<script>
/* --- Supabase config (CLOUD FAVORITES) --- */
/* TODO: paste your full anon key where indicated below */
const SUPABASE_URL = "https://ikcowmdwccnnhhucos.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrY293bWR3Y2NuY25obnVjaG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDQyMjMsImV4cCI6MjA3OTE4MDIyM30.P1aU6M4k3wZ-jXJ8xKJKesOURoQznhnaj6i8qUrUv3M";

/* Safely create Supabase client if library loaded */
let supabaseClient = null;
try {
  if (window.supabase && SUPABASE_KEY !== "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrY293bWR3Y2NuY25obnVjaG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDQyMjMsImV4cCI6MjA3OTE4MDIyM30.P1aU6M4k3wZ-jXJ8xKJKesOURoQznhnaj6i8qUrUv3M") {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
} catch (e) {
  console.error("Supabase init error:", e);
}

/* Get a per-device user email (for now). Later we can wire this to Thinkific. */
function getUserEmail(){
  const KEY = "od_flashcards_user_email";
  let email = localStorage.getItem(KEY);
  if(!email){
    email = window.prompt("Enter your email so favorites can sync across devices:", "");
    if(email){
      email = email.trim();
      localStorage.setItem(KEY,email);
    }
  }
  return email || null;
}
const USER_EMAIL = getUserEmail();

/* 1) Single deck definition — PHOTOTRANSDUCTION */
const DECK = {
  id: 'phototransduction',
  title: 'Phototransduction Flashcards',
  dataUrl: 'data/phototransduction.txt'
};
const DECK_ID = DECK.id;

/* 2) Shared image map (exported from Admin) */
async function fetchSharedImageMap(deckId){
  try{
    const r=await fetch(`images/${deckId}_image_map.json`,{cache:'no-store'});
    if(r.ok) return await r.json();
  }catch(e){}
  return {};
}
let IMAGE_MAP = {}; // filled on load

/* 3) Local favorites (fallback / offline) */
const FAV_KEY = (deckId)=>`fc_favs_student_v1::${deckId}`;
function loadFavs(deckId){
  try{
    return new Set(JSON.parse(localStorage.getItem(FAV_KEY(deckId))||'[]'));
  }catch{
    return new Set();
  }
}
function saveFavs(deckId,set){
  localStorage.setItem(FAV_KEY(deckId), JSON.stringify([...set]));
}

/* 3b) Cloud favorites via Supabase */
async function fetchCloudFavs(userEmail, deckId){
  if(!supabaseClient || !userEmail) return [];
  try{
    const { data, error } = await supabaseClient
      .from("flashcard_favorites")
      .select("card_id")
      .eq("user_email", userEmail)
      .eq("deck_id", deckId);
    if(error){
      console.error("Error loading cloud favorites:", error);
      return [];
    }
    return data.map(row => row.card_id);
  }catch(e){
    console.error("Cloud favorites fetch error:", e);
    return [];
  }
}

async function addCloudFav(userEmail, deckId, cardId){
  if(!supabaseClient || !userEmail) return;
  try{
    const { error } = await supabaseClient
      .from("flashcard_favorites")
      .upsert({ user_email:userEmail, deck_id:deckId, card_id:cardId });
    if(error) console.error("Error adding cloud favorite:", error);
  }catch(e){
    console.error("Cloud addFav error:", e);
  }
}

async function removeCloudFav(userEmail, deckId, cardId){
  if(!supabaseClient || !userEmail) return;
  try{
    const { error } = await supabaseClient
      .from("flashcard_favorites")
      .delete()
      .eq("user_email", userEmail)
      .eq("card_id", cardId);
    if(error) console.error("Error removing cloud favorite:", error);
  }catch(e){
    console.error("Cloud removeFav error:", e);
  }
}

/* 4) Parser — ONLY split on " - " (space-hyphen-space) */
function escapeHtml(s){return s.replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
function cleanLine(s){return s?s.replace(/\u00A0/g,' ').replace(/\u200B/g,'').trim():'';}
function splitAnsExpl(line){
  if(!line) return {a:'',e:''};
  const m=line.match(/^(.+?)\s-\s(.+)$/); // STRICT: space-hyphen-space only
  if(m) return {a:m[1].trim(), e:m[2].trim()};
  return {a:line.trim(), e:''};
}
function parseTxt(txt){
  const lines=txt.replace(/\r/g,'').split(/\n/).map(cleanLine);
  const isAnchor=(s)=>/^\d+\s+of\s+\d+$/i.test(s);
  const anchors=[]; for(let i=0;i<lines.length;i++) if(isAnchor(lines[i])) anchors.push(i);
  const out=[];
  for(let p=0;p<anchors.length;p++){
    const at=anchors[p], next=(p+1<anchors.length?anchors[p+1]:lines.length);
    let j=at-1; while(j>=0 && !lines[j]) j--;
    const front=escapeHtml(lines[j]||'');
    let k=at+1; while(k<next && !lines[k]) k++;
    const se=splitAnsExpl(lines[k]||'');
    out.push({id:`${DECK.id}-${p+1}`, front, backAns:escapeHtml(se.a), backExp:escapeHtml(se.e)});
  }
  return out;
}

/* 5) UI + logic */
const els={
  show:show,
  q:q,
  front:front,
  back:back,
  favBtn:fav,
  counter:counter,
  status:status,
  prev:prev,
  next:next,
  reveal:reveal
};
let CARDS=[], VIEW=[], FAVS=new Set(), idx=0, showing=false;

function imgTag(src){ return src?`<img src="${src}" alt="">`:''; }
function applyFilters(){
  const term=(els.q.value||'').toLowerCase(), favOnly=els.show.value==='fav';
  VIEW = CARDS.filter(c =>
    (!term || (c.front+c.backAns+c.backExp).toLowerCase().includes(term)) &&
    (!favOnly || FAVS.has(c.id))
  );
  if(idx>=VIEW.length) idx=Math.max(0,VIEW.length-1);
  showing=false; render();
}
function render(){
  if(!VIEW.length){
    els.front.innerHTML='<em>No cards match.</em>';
    els.back.style.display='none';
    els.back.innerHTML='';
    els.favBtn.setAttribute('aria-pressed','false');
    els.counter.textContent='0 / 0';
    els.reveal.textContent='Reveal Answer';
    els.status.textContent=DECK.title;
    return;
  }
  const c=VIEW[idx]; const map=IMAGE_MAP[c.id]||{};
  els.front.innerHTML=(c.front||'') + (map.front?imgTag(map.front):'');
  els.back.innerHTML =
    (c.backAns?`<div class="ans">${c.backAns}</div>`:'') +
    (c.backExp?`<div class="exp">${c.backExp}</div>`:'') +
    (map.back?imgTag(map.back):'');
  els.back.style.display=showing?'block':'none';
  els.favBtn.setAttribute('aria-pressed', FAVS.has(c.id)?'true':'false');
  els.counter.textContent=(idx+1)+' / '+VIEW.length;
  els.reveal.textContent=showing?'Hide Answer':'Reveal Answer';
  els.status.textContent=DECK.title + (els.show.value==='fav'?' (Favorites)':'');
}
function nextCard(){ if(!VIEW.length) return; idx=(idx+1)%VIEW.length; showing=false; render(); }
function prevCard(){ if(!VIEW.length) return; idx=(idx-1+VIEW.length)%VIEW.length; showing=false; render(); }
function toggleReveal(){ showing=!showing; render(); }

/* FAVORITE TOGGLE: local + cloud */
async function toggleFav(){
  if(!VIEW.length) return;
  const c=VIEW[idx];
  const cid = c.id;

  const isFav = FAVS.has(cid);

  if(isFav){
    FAVS.delete(cid);
    saveFavs(DECK.id,FAVS);
    render();
    // Fire-and-forget cloud delete
    if(USER_EMAIL) removeCloudFav(USER_EMAIL, DECK_ID, cid);
  }else{
    FAVS.add(cid);
    saveFavs(DECK.id,FAVS);
    render();
    // Fire-and-forget cloud add
    if(USER_EMAIL) addCloudFav(USER_EMAIL, DECK_ID, cid);
  }
}

/* load */
async function load(){
  els.counter.textContent='Loading…';
  els.status.textContent=DECK.title;
  try{
    const r=await fetch(DECK.dataUrl,{cache:'no-store'});
    if(!r.ok) throw 0;
    const t=await r.text();
    CARDS=parseTxt(t);
  }catch(e){
    CARDS=[];
  }

  // Start with local favorites
  FAVS = loadFavs(DECK.id);

  // Merge in cloud favorites if possible
  if(USER_EMAIL && supabaseClient){
    const cloudFavs = await fetchCloudFavs(USER_EMAIL, DECK_ID);
    for(const id of cloudFavs){
      FAVS.add(id);
    }
  }

  IMAGE_MAP = await fetchSharedImageMap(DECK.id);
  applyFilters();
}

/* init */
(function(){
  load();
  els.show.onchange=applyFilters;
  els.q.oninput=applyFilters;
  els.prev.onclick=prevCard;
  els.next.onclick=nextCard;
  els.reveal.onclick=toggleReveal;
  els.favBtn.onclick=toggleFav;
  document.addEventListener('keydown',e=>{
    const k=e.key.toLowerCase();
    if(k==='arrowright')      nextCard();
    else if(k==='arrowleft')  prevCard();
    else if(k==='r')          toggleReveal();
    else if(k==='s')          toggleFav();
  });
})();
</script>
</body>
</html>

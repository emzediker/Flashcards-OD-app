<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Part 2 Flashcards</title>

<style>
  body{
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
    margin:0;
    padding:20px;
    background:#fff;
    color:#111;
  }
  .wrap{max-width:980px;margin:auto;}
  h1{font-size:22px;margin:0 0 12px;}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  select,input[type=search],button{
    padding:9px 10px;
    border:1px solid #ddd;
    border-radius:8px;
    background:#fff;
  }
  .card{
    border:1px solid #ddd;
    border-radius:12px;
    padding:20px;
    min-height:220px;
    background:#fff;
    position:relative;
  }
  .front{
    font-weight:700;
    font-size:1.05rem;
  }
  .back{
    display:none;
    margin-top:14px;
    font-size:0.97rem;
    line-height:1.45;
  }
  .back strong{
    display:block;
    margin-top:10px;
    font-weight:700;
  }
  .fav{
    position:absolute;
    top:10px;
    right:10px;
    border:1px solid #ddd;
    border-radius:999px;
    padding:6px 10px;
    background:#fff;
    cursor:pointer;
  }
  .fav[aria-pressed="true"]{
    color:#e09b00;
    border-color:#caa14a;
  }
  .meta{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:10px;
    color:#555;
  }
  .nav{
    display:flex;
    gap:8px;
    margin-top:12px;
  }
  .nav button{flex:1;font-weight:600}
  .note{
    margin-top:8px;
    font-size:13px;
    color:#666;
  }
  .email-row{
    margin-bottom:10px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .email-row input{min-width:230px;}
  .note-small{font-size:12px;color:#666;margin-left:6px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="wrap">
  <h1>Part 2 Flashcards</h1>

  <div class="email-row">
    <label>Email for cloud sync:
      <input id="emailInput" type="email" placeholder="name@example.com">
    </label>
    <button id="saveEmail">Save</button>
    <span id="emailStatus" class="note-small"></span>
  </div>

  <div class="bar">
    <label>Deck:
      <select id="deck"></select>
    </label>
    <label>Show:
      <select id="show">
        <option value="all">All</option>
        <option value="fav">Favorites</option>
      </select>
    </label>
    <label>Search:
      <input id="q" type="search" placeholder="Find text...">
    </label>
  </div>

  <div class="card">
    <div id="front" class="front"></div>
    <div id="back" class="back"></div>
    <button id="fav" class="fav" aria-pressed="false">★</button>
  </div>

  <div class="meta">
    <div id="counter">0 / 0</div>
    <div id="status"></div>
  </div>

  <div class="nav">
    <button id="prev">◀ Prev</button>
    <button id="reveal">Reveal Answer</button>
    <button id="next">Next ▶</button>
  </div>

  <div class="note">
    Tip: ← / → navigate • R reveal • S star
  </div>
</div>

<script>
const SUPABASE_URL = "https://ikcowmdwccncnhnuchos.supabase.co";
const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";
let supabaseClient = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_KEY) || null;

const EMAIL_STORAGE_KEY = "oebc_flashcards_email";
let USER_EMAIL = localStorage.getItem(EMAIL_STORAGE_KEY) || null;

const DECKS = [
  { id:'oebc_retina_choroid_vitreous', title:'Retina, Choroid, Vitreous', dataUrl:'data/oebc_retina_choroid_vitreous.txt' }
];

const els = {
  deck:deck, show:show, q:q,
  front:front, back:back,
  fav:fav, counter:counter, status:status,
  prev:prev, next:next, reveal:reveal,
  emailInput:emailInput, saveEmail:saveEmail, emailStatus:emailStatus
};

let CURRENT_DECK=null, CARDS=[], VIEW=[], FAVS=new Set(), idx=0, showing=false;

function boldHeaders(text){
  return text.replace(
    /(Definition|Epidemiology|Pathophysiology|Symptoms|Clinical Signs|Complications|Treatment|Management|Follow-up)\s*:/gi,
    "<strong>$1:</strong>"
  );
}

function parseTxt(txt, deckId){
  const lines = txt.replace(/\r/g,'').split('\n').map(l=>l.trim());
  const anchors = lines.map((l,i)=>/^\d+\s+of\s+\d+$/i.test(l)?i:null).filter(i=>i!==null);
  const out=[];
  anchors.forEach((a,i)=>{
    const next = anchors[i+1] ?? lines.length;
    let j=a-1; while(j>=0 && !lines[j]) j--;
    let front=lines[j]||'';
    let k=a+1; while(k<next && !lines[k]) k++;
    let block=[];
    while(k<next && lines[k]){
      block.push(lines[k]); k++;
    }
    let back = boldHeaders(block.join('\n').replace(/\n/g,'<br><br>'));
    out.push({ id:`${deckId}-${out.length+1}`, front, back });
  });
  return out;
}

function render(){
  if(!VIEW.length){
    els.front.innerHTML='<em>No cards</em>';
    els.back.style.display='none';
    return;
  }
  const c=VIEW[idx];
  els.front.textContent=c.front;
  els.back.innerHTML=c.back;
  els.back.style.display=showing?'block':'none';
  els.counter.textContent=`${idx+1} / ${VIEW.length}`;
  els.reveal.textContent=showing?'Hide Answer':'Reveal Answer';
}

function loadDeck(id){
  CURRENT_DECK=DECKS.find(d=>d.id===id);
  fetch(CURRENT_DECK.dataUrl).then(r=>r.text()).then(txt=>{
    CARDS=parseTxt(txt,CURRENT_DECK.id);
    VIEW=[...CARDS];
    idx=0; showing=false;
    render();
  });
}

els.deck.innerHTML=DECKS.map(d=>`<option value="${d.id}">${d.title}</option>`).join('');
els.deck.onchange=()=>loadDeck(els.deck.value);
els.prev.onclick=()=>{idx=(idx-1+VIEW.length)%VIEW.length; showing=false; render();};
els.next.onclick=()=>{idx=(idx+1)%VIEW.length; showing=false; render();};
els.reveal.onclick=()=>{showing=!showing; render();};

loadDeck(DECKS[0].id);
</script>
</body>
</html>

<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Part 2 Flashcards</title>

<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;padding:20px;background:#fff;color:#111;}
  .wrap{max-width:980px;margin:auto;}
  h1{font-size:22px;margin:0 0 12px;}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  select,input[type=search],button{padding:9px 10px;border:1px solid #ddd;border-radius:8px;background:#fff}
  .card{border:1px solid #ddd;border-radius:12px;padding:20px;min-height:180px;background:#fff;position:relative}
  .front{font-weight:600}
  .back{display:none;margin-top:12px}

  .back .exp{
    color:#111;
    font-size:0.98rem;
    line-height:1.55;
    white-space:normal;
  }

  .sec{
    font-weight:800;
    display:block;
    margin-top:12px;
    margin-bottom:4px;
  }
  .back .exp .sec:first-child{ margin-top:0; }

  .card img{max-width:100%;height:auto;border-radius:8px;margin-top:10px}
  .fav{position:absolute;top:10px;right:10px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .fav[aria-pressed="true"]{color:#e09b00;border-color:#caa14a}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#555}
  .nav{display:flex;gap:8px;margin-top:10px}
  .nav button{flex:1;font-weight:600}
  .note{margin-top:8px;font-size:13px;color:#666}

  .email-row{margin-bottom:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .email-row input{min-width:230px;}
  .note-small{font-size:12px;color:#666;margin-left:6px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="wrap">
<h1>Part 2 Flashcards</h1>

<div class="email-row">
  <label>Email for cloud sync:
    <input id="emailInput" type="email" placeholder="name@example.com">
  </label>
  <button id="saveEmail">Save</button>
  <span id="emailStatus" class="note-small"></span>
</div>

<div class="bar">
  <label>Deck:
    <select id="deck"></select>
  </label>
  <label>Show:
    <select id="show">
      <option value="all">All</option>
      <option value="fav">Favorites</option>
    </select>
  </label>
  <label>Search:
    <input id="q" type="search" placeholder="Find text...">
  </label>
</div>

<div class="card">
  <div class="front" id="front"></div>
  <div class="back" id="back"></div>
  <button id="fav" class="fav" aria-pressed="false">★</button>
</div>

<div class="meta">
  <div id="counter">0 / 0</div>
  <div id="status"></div>
</div>

<div class="nav">
  <button id="prev">◀ Prev</button>
  <button id="reveal">Reveal Answer</button>
  <button id="next">Next ▶</button>
</div>

<div class="note">Tip: ←/→ navigate · R reveal · S favorite</div>
<div class="note" id="cloudStatus"></div>
</div>

<script>
const SECTION_LABELS = [
  "Definition","Epidemiology","Etiology","Pathophysiology","Symptoms",
  "Clinical Signs","Signs","Complications","Management","Treatment",
  "Follow-up","Follow Up","Classification","Types","Risk Factors",
  "Diagnosis","Prognosis","Severity","Stages"
];

function escapeHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function formatSections(raw){
  const lines = raw.split(/\n/);
  return lines.map(line=>{
    const m = line.match(/^([A-Za-z][A-Za-z\s\-\/()]{2,40})(:)?\s*(.*)$/);
    if(m && SECTION_LABELS.some(l=>l.toLowerCase()===m[1].toLowerCase())){
      return `<span class="sec">${escapeHtml(m[1])}${m[2]||""}</span>${escapeHtml(m[3])}`;
    }
    return escapeHtml(line);
  }).join("<br>");
}

function parseTxt(txt, deckId){
  const lines = txt.replace(/\r/g,'').split(/\n/).map(l=>l.trim());
  const anchors = lines.map((l,i)=>/^\d+\s+of\s+\d+$/i.test(l)?i:-1).filter(i=>i>=0);
  const cards=[];

  for(let i=0;i<anchors.length;i++){
    const at=anchors[i], next=anchors[i+1]||lines.length;
    let j=at-1; while(j>=0&&!lines[j]) j--;
    const front=escapeHtml(lines[j]||"");

    let k=at+1; while(k<next&&!lines[k]) k++;
    const body=[];
    for(let m=k;m<next&&lines[m];m++) body.push(lines[m]);

    cards.push({
      id:`${deckId}-${cards.length+1}`,
      front,
      backHtml:formatSections(body.join("\n"))
    });
  }
  return cards;
}

/* UI logic unchanged from your working version — intentionally */
</script>
</body>
</html>

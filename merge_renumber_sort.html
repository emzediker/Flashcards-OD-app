<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Merge by “Deck X of Y” + Renumber</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;padding:18px;background:#fff;color:#111}
  .card{max-width:900px;margin:auto;border:1px solid #ddd;border-radius:12px;padding:18px}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  input[type=file]{padding:9px 12px;border:1px solid #ccc;border-radius:8px}
  button{padding:10px 14px;border:1px solid #999;border-radius:8px;background:#0a7;color:#fff;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:#666;font-size:13px}
  .box{padding:10px;border:1px dashed #bbb;border-radius:8px;background:#fafafa;margin-top:10px}
  .ok{color:#0a7}
  .warn{color:#b46900}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #eee;padding:6px 8px;text-align:left;font-size:13px}
</style>
</head>
<body>
<div class="card">
  <h1>Merge by “Deck X of Y” + Renumber (no split)</h1>
  <div class="row">
    <input id="files" type="file" multiple accept=".txt,text/plain">
    <button id="analyzeBtn">Analyze & Sort</button>
    <button id="mergeBtn" disabled>Merge + Renumber</button>
  </div>
  <div class="muted">
    Select ALL TXT files (any order). This tool will detect “Deck 1 of 4”, “Deck 2 of 4”, etc., sort by that, then merge and renumber anchors (“1 of N”…“N of N”).
  </div>

  <div id="result" class="box">
    <div id="status">Waiting for files…</div>
    <div id="tableWrap"></div>
    <div class="row" style="margin-top:8px">
      <button id="downloadBtn" disabled>Download Merged File</button>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const filesInput = $('#files');
const analyzeBtn = $('#analyzeBtn');
const mergeBtn = $('#mergeBtn');
const statusEl = $('#status');
const tableWrap = $('#tableWrap');
const dlBtn = $('#downloadBtn');

let loaded = [];     // {name, text, order, rawOrderText}
let mergedBlob = null;

function readAsText(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(String(r.result||''));r.onerror=rej;r.readAsText(f);});}
function cleanLine(s){
  return s.replace(/\u00A0/g,' ')
          .replace(/\u200B/g,'')
          .replace(/\uFFFD/g,'')
          .replace(/[“”]/g,'"')
          .replace(/[‘’]/g,"'")
          .replace(/\u2013|\u2014/g,'-')
          .replace(/[ \t]+$/,'');
}

// Detect “Deck X of Y” anywhere in the file (first match wins)
function detectDeckOrder(txt){
  const t = txt.replace(/\r/g,'\n');
  // common patterns:
  // "Deck 2 of 4"
  // "Basic Level\nDeck 7 of 11"
  // "Pharmacology\nBasic Level\nDeck 7 of 11\n100 flashcards"
  const re = /deck\s*(\d+)\s*of\s*(\d+)/i;
  const m = t.match(re);
  if (m){
    return { order: parseInt(m[1],10), raw: m[0] };
  }
  return { order: null, raw: '' };
}

function renderTable(){
  if(!loaded.length){ tableWrap.innerHTML=''; return; }
  const rows = loaded.map(x=>{
    const ord = (x.order==null)?'<span class="warn">not found</span>':x.order;
    return `<tr><td>${x.name}</td><td>${ord}</td><td>${x.rawOrderText||''}</td></tr>`;
  }).join('');
  tableWrap.innerHTML = `
    <table>
      <thead><tr><th>File</th><th>Detected Deck #</th><th>Matched text</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="muted">Files are sorted ascending by “Deck #”. If any file shows “not found”, it will be placed at the end in filename order.</div>
  `;
}

function findAnchors(lines){
  const re = /^\s*(\d+)\s+of\s+(\d+)\s*$/i;
  const idx=[];
  for(let i=0;i<lines.length;i++){ if(re.test(lines[i])) idx.push(i); }
  return idx;
}

function renumberAnchors(whole){
  const lines = whole.replace(/\r/g,'').split('\n').map(cleanLine);
  const anchors = findAnchors(lines);
  if(!anchors.length){
    return { text: whole, count: 0 };
  }
  // Split into blocks by anchors
  const blocks=[];
  for(let i=0;i<anchors.length;i++){
    const start = anchors[i];
    const end   = (i+1<anchors.length) ? anchors[i+1] : lines.length;
    blocks.push(lines.slice(start, end));
  }
  const total = blocks.length;
  // Rewrite each first line as “i of total”
  for(let i=0;i<total;i++){
    blocks[i][0] = `${i+1} of ${total}`;
  }
  return { text: blocks.map(b=>b.join('\n')).join('\n'), count: total };
}

analyzeBtn.onclick = async () => {
  dlBtn.disabled = true; mergeBtn.disabled = true; mergedBlob = null;
  statusEl.innerHTML = 'Reading files…';
  const files = [...(filesInput.files||[])];
  if(!files.length){ statusEl.innerHTML = '<span class="warn">No files selected.</span>'; return; }

  try{
    const texts = await Promise.all(files.map(readAsText));
    loaded = texts.map((txt,i) => {
      const d = detectDeckOrder(txt);
      return {
        name: files[i].name,
        text: txt,
        order: d.order,
        rawOrderText: d.raw
      };
    });

    // sort: first by order (nulls last), then by filename
    loaded.sort((a,b)=>{
      if(a.order==null && b.order==null) return a.name.localeCompare(b.name, undefined, {numeric:true});
      if(a.order==null) return 1;
      if(b.order==null) return -1;
      return a.order - b.order;
    });

    renderTable();
    statusEl.innerHTML = `<span class="ok">Analyzed ${loaded.length} files. Ready to merge.</span>`;
    mergeBtn.disabled = false;
  }catch(e){
    console.error(e);
    statusEl.innerHTML = '<span class="warn">Error reading files.</span>';
  }
};

mergeBtn.onclick = ()=>{
  if(!loaded.length){ statusEl.innerHTML = '<span class="warn">Nothing to merge.</span>'; return; }
  statusEl.innerHTML = 'Merging in detected order…';
  const merged = loaded.map(x=>x.text).join('\n');
  const { text, count } = renumberAnchors(merged);
  if(!count){
    statusEl.innerHTML = '<span class="warn">No “X of Y” anchors found to renumber. File still merged.</span>';
  }else{
    statusEl.innerHTML = `<span class="ok">Merged ${loaded.length} files, ${count} cards renumbered.</span>`;
  }
  mergedBlob = new Blob([text], {type:'text/plain'});
  dlBtn.disabled = false;
};

dlBtn.onclick = ()=>{
  if(!mergedBlob) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(mergedBlob);
  a.download = 'merged_renumbered.txt';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1500);
};
</script>
</body>
</html>

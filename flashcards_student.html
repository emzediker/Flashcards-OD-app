<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OD on the GO – Systemic A&P Flashcards</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;padding:20px;background:#fff;color:#111;}
  .wrap{max-width:960px;margin:auto;}
  h1{font-size:22px;margin-bottom:12px;}
  .card{border:1px solid #ddd;border-radius:12px;padding:20px;min-height:180px;background:#fff;}
  .front{font-weight:600;}
  .back{display:none;margin-top:12px;}
  .ans{font-weight:700;font-size:1.05rem;margin:2px 0 6px;}
  .exp{color:#555;font-size:0.95rem;line-height:1.35;}
  .card img{max-width:100%;height:auto;border-radius:8px;margin-top:10px;}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#555;}
  .nav{display:flex;gap:8px;margin-top:10px;}
  .nav button{flex:1;padding:10px;font-weight:600;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;}
  .note{margin-top:8px;font-size:13px;color:#666;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Systemic Anatomy, Physiology & Disease</h1>

  <div class="card" id="card">
    <div class="front" id="front"></div>
    <div class="back" id="back"></div>
  </div>

  <div class="meta">
    <div id="counter">Loading…</div>
    <div id="status"></div>
  </div>

  <div class="nav">
    <button id="prev">◀ Prev</button>
    <button id="reveal">Reveal Answer</button>
    <button id="next">Next ▶</button>
  </div>

  <div class="note">Tip: Use ← / → arrows to move, and R to reveal answers.</div>
</div>

<script>
// -------------------- Image mapping from your export --------------------
const imgMap = {
  "systemic_basic-12":{"back":"images/IMG_5772.jpeg"},
  "systemic_basic-13":{"back":"images/IMG_5774.jpeg"},
  "systemic_basic-14":{"back":"images/IMG_5776.jpeg"},
  "systemic_basic-15":{"back":"images/IMG_5778.jpeg"},
  "systemic_basic-16":{"back":"images/IMG_5780.jpeg"},
  "systemic_basic-17":{"back":"images/IMG_5782.jpeg"},
  "systemic_basic-19":{"back":"images/IMG_5784.jpeg"},
  "systemic_basic-23":{"back":"images/IMG_5786.jpeg"},
  "systemic_basic-25":{"back":"images/IMG_5788.jpeg"},
  "systemic_basic-26":{"back":"images/IMG_5790.jpeg"},
  "systemic_basic-27":{"back":"images/IMG_5792.jpeg"},
  "systemic_basic-28":{"back":"images/IMG_5794.jpeg"},
  "systemic_basic-29":{"back":"images/IMG_5796.jpeg"},
  "systemic_basic-30":{"back":"images/IMG_5798.jpeg"},
  "systemic_basic-43":{"back":"images/IMG_5800.jpeg"},
  "systemic_basic-47":{"back":"images/IMG_5802.jpeg"},
  "systemic_basic-56":{"back":"images/IMG_6041.jpeg"},
  "systemic_basic-70":{"back":"images/IMG_5804.jpeg"}
};

// -------------------- Deck config --------------------
const deck = {
  id: 'systemic_basic',
  title: 'Systemic Anatomy – Basic Body Organization & Chemistry',
  dataUrl: 'data/systemic_basic.txt',
  totalHint: 95
};

let cards = [];
let i = 0;
let showing = false;

// -------------------- Sanitizer (same as admin) --------------------
function escapeHtml(s){
  return s.replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
}
function cleanLine(s){
  if (!s) return '';
  return s
    .replace(/\u00A0/g, ' ')       // NBSP -> space
    .replace(/\u200B/g, '')        // zero-width space
    .replace(/\uFFFD/g, '')        // replacement char
    .replace(/[“”]/g, '"')         // smart quotes
    .replace(/[‘’]/g, "'")
    .replace(/\u2013|\u2014/g, '-')// en/em dash -> hyphen
    .replace(/[^\S\r\n]+/g, ' ')   // collapse odd spaces
    .trim();
}

// -------------------- Answer/Explanation splitter --------------------
function splitAnswerExplanation(line){
  // Answer: explanation  OR  Answer - explanation
  let m = line.match(/^(.{1,80}?)[\s]*[:–—-]\s+(.{12,})$/);
  if (m) return {a: m[1].trim(), e: m[2].trim()};

  // Short phrase + capitalized sentence
  m = line.match(/^(.{1,60}?)[ ]{1,}([A-Z].{10,})$/);
  if (m && !/[.?!]$/.test(m[1])) return {a: m[1].trim(), e: m[2].trim()};

  // First short sentence as answer
  const dot = line.indexOf('. ');
  if (dot > 0 && dot <= 80) {
    const first = line.slice(0, dot).trim();
    const rest  = line.slice(dot + 2).trim();
    if (first.split(/\s+/).length <= 6) return {a: first, e: rest};
  }

  // Fallback: all answer, no explanation
  return {a: line.trim(), e: ''};
}

// -------------------- Parser (same logic as admin) --------------------
function parseTxt(txt, totalHint){
  const rawLines = txt.replace(/\r/g,'').split(/\n/);
  const lines = rawLines.map(l => cleanLine(l));
  const isAnchor = (line) => new RegExp(String.raw`^\d+\s+of\s+${totalHint}$`).test(line);

  const anchors = [];
  for (let idx=0; idx<lines.length; idx++){
    if (isAnchor(lines[idx])) anchors.push(idx);
  }

  const out = [];
  for (let p=0; p<anchors.length; p++){
    const at   = anchors[p];
    const next = (p+1 < anchors.length) ? anchors[p+1] : lines.length;

    // FRONT = nearest non-empty above (within a small window)
    let j = at-1, front = '', up = 6;
    while (j>=0 && up>0 && !lines[j]) { j--; up--; }
    if (j>=0 && lines[j]) front = escapeHtml(lines[j]);

    // BACK = first non-empty after anchor (ignore lone ".")
    let k = at+1;
    while (k<next && (!lines[k] || lines[k]==='.')) k++;
    const backRaw = (k<next) ? lines[k] : '';
    const split   = splitAnswerExplanation(backRaw);
    const backAns = escapeHtml(split.a);
    const backExp = escapeHtml(split.e);

    // Optional note only if next line starts with Note:/Hint:/Comment:
    let m = k+1; while (m<next && !lines[m]) m++;
    let backExp2 = backExp;
    if (m<next && /^(note|hint|comment)\s*:/i.test(lines[m])) {
      backExp2 += (backExp ? ' ' : '') + `<em>${escapeHtml(lines[m])}</em>`;
    }

    out.push({
      id: `${deck.id}-${out.length+1}`,
      front,
      ans: backAns,
      exp: backExp2
    });
  }
  return out;
}

// -------------------- UI helpers --------------------
function imgTag(src){ return src ? `<img src="${src}" alt="">` : ''; }

function render(){
  const c = cards[i];
  if (!c){
    document.getElementById('front').innerHTML = '<em>No cards found. Check your data file and total count.</em>';
    document.getElementById('back').innerHTML  = '';
    document.getElementById('counter').textContent = '0 / 0';
    document.getElementById('status').textContent  = '';
    return;
  }
  document.getElementById('front').innerHTML = c.front;
  const pair = imgMap[c.id] || {};
  document.getElementById('back').innerHTML =
    (c.ans ? `<div class="ans">${c.ans}</div>` : '') +
    (c.exp ? `<div class="exp">${c.exp}</div>` : '') +
    (pair.back ? imgTag(pair.back) : '');
  document.getElementById('back').style.display = showing ? 'block' : 'none';
  document.getElementById('counter').textContent = (i+1) + ' / ' + cards.length;
  document.getElementById('status').textContent  = deck.title;
  document.getElementById('reveal').textContent  = showing ? 'Hide Answer' : 'Reveal Answer';
}

function next(){ i = (i+1) % cards.length; showing = false; render(); }
function prev(){ i = (i-1+cards.length) % cards.length; showing = false; render(); }
function toggle(){ showing = !showing; render(); }

// -------------------- Boot --------------------
async function loadDeck(){
  try{
    const res = await fetch(deck.dataUrl, {cache:'no-store'});
    if (!res.ok) throw new Error('Deck text not found');
    const txt = await res.text();
    cards = parseTxt(txt, deck.totalHint);
  }catch(e){
    console.error(e);
    cards = [];
  }
  i = 0; showing = false; render();
}
document.getElementById('next').onclick = next;
document.getElementById('prev').onclick = prev;
document.getElementById('reveal').onclick = toggle;
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowRight') next();
  else if (e.key === 'ArrowLeft') prev();
  else if (e.key.toLowerCase() === 'r') toggle();
});
loadDeck();
</script>
</body>
</html>

<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phototransduction Flashcards</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;padding:20px;background:#fff;color:#111;}
  .wrap{max-width:980px;margin:auto;}
  h1{font-size:22px;margin:0 0 12px;}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  select,input[type=search],button{padding:9px 10px;border:1px solid #ddd;border-radius:8px;background:#fff}
  .card{border:1px solid #ddd;border-radius:12px;padding:20px;min-height:180px;background:#fff;position:relative}
  .front{font-weight:600}
  .back{display:none;margin-top:12px}
  .ans{font-weight:700;font-size:1.06rem;margin:2px 0 6px}
  .exp{color:#555;font-size:0.96rem;line-height:1.35}
  .card img{max-width:100%;height:auto;border-radius:8px;margin-top:10px}
  .fav{position:absolute;top:10px;right:10px;border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .fav[aria-pressed="true"]{color:#e09b00;border-color:#caa14a}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#555}
  .nav{display:flex;gap:8px;margin-top:10px}
  .nav button{flex:1;font-weight:600}
  .note{margin-top:8px;font-size:13px;color:#666}
  .email-row{margin-bottom:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .email-row input{min-width:230px;}
  .note-small{font-size:12px;color:#666;margin-left:6px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h1>Phototransduction Flashcards</h1>

  <div class="email-row">
    <label>
      Email for cloud sync:
      <input id="emailInput" type="email" placeholder="name@example.com">
    </label>
    <button id="saveEmail">Save</button>
    <span id="emailStatus" class="note-small"></span>
  </div>

  <div class="bar">
    <label>Show:
      <select id="show">
        <option value="all">All</option>
        <option value="fav">Favorites</option>
      </select>
    </label>
    <label>Search:
      <input id="q" type="search" placeholder="Find text...">
    </label>
  </div>

  <div class="card" id="card">
    <div class="front" id="front"></div>
    <div class="back" id="back"></div>
    <button id="fav" class="fav" aria-pressed="false">★</button>
  </div>

  <div class="meta">
    <div id="counter">0 / 0</div>
    <div id="status"></div>
  </div>

  <div class="nav">
    <button id="prev">◀ Prev</button>
    <button id="reveal">Reveal Answer</button>
    <button id="next">Next ▶</button>
  </div>

  <div class="note">
    Tip: ←/→ to move, R to reveal, S to star. Favorites save locally and in the cloud when an email is set.
  </div>
  <div class="note" id="cloudStatus"></div>
</div>

<script>
/* ---- Supabase Configuration ---- */
const SUPABASE_URL = "https://ikcowmdwccncnhnuchos.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrY293bWR3Y2NuY25obnVjaG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDQyMjMsImV4cCI6MjA3OTE4MDIyM30.P1aU6M4k3wZ-jXJ8xKJKesOURoQznhnaj6i8qUrUv3M";

let supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* Email storage */
const EMAIL_STORAGE_KEY = "od_flashcards_user_email";
let USER_EMAIL = null;

/* Deck setup */
const DECK = {
  id: "phototransduction",
  title: "Phototransduction Flashcards",
  dataUrl: "data/phototransduction.txt"
};
const DECK_ID = DECK.id;

/* Image map loader */
async function fetchSharedImageMap(deckId){
  try{
    const r = await fetch(`images/${deckId}_image_map.json`, {cache:"no-store"});
    if(r.ok) return await r.json();
  }catch{}
  return {};
}
let IMAGE_MAP = {};

/* Local favorites */
const FAV_KEY = d => `fc_favs_student_v1::${d}`;
function loadFavs(d){
  try{return new Set(JSON.parse(localStorage.getItem(FAV_KEY(d))||"[]"));}catch{return new Set();}
}
function saveFavs(d,set){
  localStorage.setItem(FAV_KEY(d), JSON.stringify([...set]));
}

/* Cloud favorites */
async function fetchCloudFavs(email, deckId){
  if(!email) return [];
  const {data,error} = await supabaseClient
    .from("flashcard_favorites")
    .select("card_id")
    .eq("user_email", email)
    .eq("deck_id", deckId);
  return data?.map(r=>r.card_id)||[];
}

async function addCloudFav(email, deckId, cardId){
  if(!email) return;
  await supabaseClient
    .from("flashcard_favorites")
    .upsert({user_email:email, deck_id:deckId, card_id:cardId});
}

async function removeCloudFav(email, deckId, cardId){
  if(!email) return;
  await supabaseClient
    .from("flashcard_favorites")
    .delete()
    .eq("user_email", email)
    .eq("card_id", cardId);
}

/* Parser */
function escapeHtml(s){return s.replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));}
function cleanLine(s){return s.replace(/\u00A0/g," ").replace(/\u200B/g,"").trim();}
function splitAnsExpl(line){
  const m = line.match(/^(.+?) - (.+)$/);
  return m ? {a:m[1],e:m[2]} : {a:line,e:""};
}
function parseTxt(txt){
  const lines = txt.replace(/\r/g,"").split("\n").map(cleanLine);
  const anchors = lines.map((l,i)=>/^\d+\s+of\s+\d+$/i.test(l)?i:null).filter(i=>i!==null);
  const out = [];
  for(let p=0;p<anchors.length;p++){
    const at=anchors[p], next=(anchors[p+1]||lines.length);
    let j=at-1; while(j>=0 && !lines[j]) j--;
    let k=at+1; while(k<next && !lines[k]) k++;
    const se=splitAnsExpl(lines[k]||"");
    out.push({
      id:`${DECK.id}-${p+1}`,
      front:escapeHtml(lines[j]||""),
      backAns:escapeHtml(se.a),
      backExp:escapeHtml(se.e)
    });
  }
  return out;
}

/* UI refs */
const els = {
  show, q, front, back, favBtn:fav, counter, status, prev, next, reveal,
  emailInput, saveEmail, emailStatus, cloudStatus
};

/* State */
let CARDS=[],VIEW=[],FAVS=new Set(),idx=0,showing=false;

/* Rendering */
function render(){
  if(!VIEW.length){
    els.front.innerHTML="<em>No cards match.</em>";
    els.back.style.display="none";
    els.favBtn.setAttribute("aria-pressed","false");
    els.counter.textContent="0 / 0";
    return;
  }
  const c=VIEW[idx];
  const map=IMAGE_MAP[c.id]||{};
  els.front.innerHTML=c.front + (map.front?`<img src="${map.front}">`:"");
  els.back.innerHTML=
    (c.backAns?`<div class="ans">${c.backAns}</div>`:"") +
    (c.backExp?`<div class="exp">${c.backExp}</div>`:"") +
    (map.back?`<img src="${map.back}">`:"");
  els.back.style.display=showing?"block":"none";
  els.favBtn.setAttribute("aria-pressed", FAVS.has(c.id)?"true":"false");
  els.counter.textContent=(idx+1)+" / "+VIEW.length;
}

/* Actions */
function applyFilters(){
  const term=(els.q.value||"").toLowerCase();
  const favOnly=els.show.value==="fav";
  VIEW=CARDS.filter(c=>
    (!term || (c.front+c.backAns+c.backExp).toLowerCase().includes(term)) &&
    (!favOnly || FAVS.has(c.id))
  );
  if(idx>=VIEW.length) idx=0;
  showing=false;
  render();
}

function nextCard(){if(VIEW.length){idx=(idx+1)%VIEW.length;showing=false;render();}}
function prevCard(){if(VIEW.length){idx=(idx-1+VIEW.length)%VIEW.length;showing=false;render();}}
function toggleReveal(){showing=!showing;render();}

async function toggleFav(){
  if(!VIEW.length) return;
  const id=VIEW[idx].id;
  const isFav=FAVS.has(id);

  if(isFav){
    FAVS.delete(id);
    saveFavs(DECK_ID,FAVS);
    render();
    removeCloudFav(USER_EMAIL,DECK_ID,id);
  } else {
    FAVS.add(id);
    saveFavs(DECK_ID,FAVS);
    render();
    addCloudFav(USER_EMAIL,DECK_ID,id);
  }
}

/* Cloud sync */
async function syncCloudFavs(){
  if(!USER_EMAIL){
    els.cloudStatus.textContent="Cloud: No email set.";
    applyFilters(); return;
  }
  const cloud=await fetchCloudFavs(USER_EMAIL,DECK_ID);
  cloud.forEach(id=>FAVS.add(id));
  saveFavs(DECK_ID,FAVS);
  els.cloudStatus.textContent=`Cloud: loaded ${cloud.length} favorites for ${USER_EMAIL}`;
  applyFilters();
}

/* Load deck */
async function load(){
  const r=await fetch(DECK.dataUrl,{cache:"no-store"});
  const t=await r.text();
  CARDS=parseTxt(t);
  FAVS=loadFavs(DECK_ID);
  await syncCloudFavs();
  IMAGE_MAP=await fetchSharedImageMap(DECK_ID);
  applyFilters();
}

/* Init */
(function(){
  USER_EMAIL=(localStorage.getItem(EMAIL_STORAGE_KEY)||"").trim()||null;
  if(USER_EMAIL) els.emailInput.value=USER_EMAIL;
  els.emailStatus.textContent=USER_EMAIL?`Using ${USER_EMAIL}`:"No email set.";

  els.saveEmail.onclick=async()=>{
    const v=els.emailInput.value.trim();
    if(v){
      USER_EMAIL=v;
      localStorage.setItem(EMAIL_STORAGE_KEY,v);
    }else{
      USER_EMAIL=null;
      localStorage.removeItem(EMAIL_STORAGE_KEY);
    }
    els.emailStatus.textContent=USER_EMAIL?`Using ${USER_EMAIL}`:"No email set.";
    FAVS=loadFavs(DECK_ID);
    await syncCloudFavs();
  };

  els.show.onchange=applyFilters;
  els.q.oninput=applyFilters;
  els.prev.onclick=prevCard;
  els.next.onclick=nextCard;
  els.reveal.onclick=toggleReveal;
  els.favBtn.onclick=toggleFav;

  document.addEventListener("keydown",e=>{
    const k=e.key.toLowerCase();
    if(k==="arrowright") nextCard();
    else if(k==="arrowleft") prevCard();
    else if(k==="r") toggleReveal();
    else if(k==="s") toggleFav();
  });

  load();
})();
</script>
</body>
</html>

<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Basic Pharm — 11 files ➜ 4 decks (merge & renumber)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:20px;max-width:900px}
  h1{font-size:20px;margin:0 0 10px}
  .box{border:1px solid #ddd;border-radius:10px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button,input[type=file]{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fff}
  .log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:8px;padding:10px;margin-top:10px;font-size:13px}
  a.dl{display:inline-block;margin:6px 8px 0 0}
</style>
</head>
<body>
<h1>Basic Pharmacology splitter (11 source decks ➜ 4 balanced decks)</h1>
<div class="box">
  <div class="row">
    <input id="files" type="file" accept=".txt" multiple>
    <button id="go">Process</button>
  </div>
  <div class="log" id="log">Select your 11 TXT files, then click Process.</div>
  <div id="links"></div>
</div>

<script>
const log = (...m)=>{ const el=document.getElementById('log'); el.textContent += "\n" + m.join(' '); };
const setlog = (t)=>{ document.getElementById('log').textContent = t; };

function detectDeckNumber(txt){
  // looks for: Deck 1 of 11  /  Deck 10 of 11  (case-insensitive, ignores stray chars)
  const m = txt.match(/deck\s*(\d+)\s*of\s*11/i);
  return m ? parseInt(m[1],10) : null;
}

function findAnchorLines(lines){
  // anchor looks like: "23 of 100" (any y); we treat any  "n of y" as anchor
  const re = /^\s*\d+\s+of\s+\d+\s*$/i;
  const idx = [];
  for (let i=0;i<lines.length;i++){
    if (re.test(lines[i])) idx.push(i);
  }
  return idx;
}

function sliceCardsByAnchors(lines){
  const anchors = findAnchorLines(lines);
  const cards = [];
  for (let p=0;p<anchors.length;p++){
    const start = (p===0 ? 0 : anchors[p-1]+1);
    const end   = (p+1<anchors.length ? anchors[p+1] : lines.length);
    const seg = lines.slice(start,end);
    // remember where the current anchor is (relative index inside seg)
    const relAnchor = seg.findIndex(s => /^\s*\d+\s+of\s+\d+\s*$/i.test(s));
    cards.push({seg, relAnchor});
  }
  return cards;
}

function renumber(cards){
  const N = cards.length;
  for (let k=0;k<N;k++){
    const c = cards[k];
    const anchorLine = `${k+1} of ${N}`;
    if (c.relAnchor >= 0) c.seg[c.relAnchor] = anchorLine;
    else {
      // fallback: if we somehow didn't see an anchor, inject one at the end
      c.seg.push(anchorLine);
    }
  }
  return cards;
}

function splitIntoFour(cards){
  const total = cards.length;
  // Split as evenly as possible, earlier decks can be +1 when uneven
  const base = Math.floor(total/4);
  const extra = total % 4; // first "extra" decks get +1
  const sizes = [0,1,2,3].map(i => base + (i<extra?1:0));
  const groups = [];
  let pos = 0;
  for (let i=0;i<4;i++){
    groups.push(cards.slice(pos, pos+sizes[i]));
    pos += sizes[i];
  }
  return groups;
}

async function readFile(f){
  const txt = await f.text();
  return {name:f.name, txt};
}

document.getElementById('go').onclick = async ()=>{
  const input = document.getElementById('files');
  const files = Array.from(input.files||[]);
  document.getElementById('links').innerHTML = '';
  if (files.length === 0){ setlog('Select your 11 TXT files, then click Process.'); return; }
  setlog(`Reading ${files.length} file(s)…`);

  // 1) read files
  const items = await Promise.all(files.map(readFile));

  // 2) sort by “Deck X of 11”
  const withOrder = [];
  for (const it of items){
    const n = detectDeckNumber(it.txt);
    if (n==null){ log(`⚠️ Could not find "Deck X of 11" in: ${it.name} — it will be placed at the end.`); }
    withOrder.push({order:n??9999, name:it.name, txt:it.txt});
  }
  withOrder.sort((a,b)=> a.order - b.order);

  // 3) merge lines
  const merged = withOrder.map(x => x.txt.replace(/\r/g,'')).join('\n');
  const lines = merged.split('\n');

  // 4) cut into individual cards using anchor lines
  const cards = sliceCardsByAnchors(lines);
  const totalCards = cards.length;

  if (totalCards === 0){
    setlog('❌ No anchor lines like "n of y" found. Check your files.');
    return;
  }
  setlog(`Found ${totalCards} cards. Splitting into four balanced decks…`);

  // 5) split into four groups, then renumber anchors inside each group
  const groups = splitIntoFour(cards);
  const outTexts = groups.map((arr, i)=>{
    const r = renumber(arr);
    // flatten back to text
    const text = r.map(c => c.seg.join('\n')).join('\n');
    return {idx:i+1, count:r.length, text};
  });

  // 6) show downloads + summary
  const links = document.getElementById('links');
  links.innerHTML = '';
  outTexts.forEach(({idx,count,text})=>{
    const blob = new Blob([text], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `pharm_basic_${idx}.txt`;
    a.textContent = `⬇️ Download pharm_basic_${idx}.txt  (${count} cards)`;
    a.className = 'dl';
    links.appendChild(a);
  });

  setlog(`Done. Click each download link above, then upload those four files into your repo's data/ folder and point your deck list at them.`);
};
</script>
</body>
</html>
